<html>

<head>
<%- include('header') %>
  <script src="https://cdn.bootcdn.net/ajax/libs/vue/3.5.20/vue.global.prod.js"></script>
  <script src="https://cdn.bootcdn.net/ajax/libs/reconnecting-websocket/1.0.0/reconnecting-websocket.min.js"></script>
  <script src="tiaoom.js"></script>
</head>

<body>
  <article id="app">
    <section class="container">
      <aside class="aside border-r">
        <p class="header">
          <span>欢迎回来~ <%=player.name%></span>
          <input :title="playerStatus == 'playing' ? '游戏中不可退出账号' : ''" :disabled="playerStatus == 'playing'" type="button" value="退出" onclick="location.href='/logout'" />
        </p>
        <h2>在线玩家</h2>
        <ul class="list">
          <li v-for="p in players" :key="p.id">{{ p.name }}</li>
        </ul>
        <h2>在线房间</h2>
        <ul class="list">
          <li :id="`room${r.id}`" v-for="r in rooms" :key="r.id" class="space-x-2">
            <b v-if="r.players.some(p => p.id == player.id)">{{ r.name }} ({{ r.players.filter(p => p.role == 'player').length }}/{{ r.size }})</b>
            <span v-else>{{ r.name }} ({{ r.players.length }}/{{ r.size }})</span>
            <span v-if="!r.players.some(p => p.id == player.id)">
              <input type="button" :value="r.status == 'waiting' && r.players.length < r.size ? '进入' : '围观'" @click="game.joinRoom(r.id)" />
            </span>
          </li>
        </ul>
        <span v-if="rooms.length == 0">暂无房间</span>
      </aside>
      <main class="main h-full">
        <form name="room" id="room" v-if="!roomPlayer">
          <h3>创建房间</h3>
          <p class="group flex-middle">
            <input type="text" name="name" placeholder="房间名称" v-model="room.name" required />
            <select name="type" v-model="room.attrs.type">
              <option value="spy">谁是卧底？</option>
              <option value="gobang">五子棋</option>
            </select>
            <select v-if="room.attrs.type === 'spy'" name="size" v-model="room.size" @change="room.minSize = Math.min(room.minSize, room.size)">
              <option value="4">4 玩家</option>
              <option value="5">5 玩家</option>
              <option value="6">6 玩家</option>
              <option value="7">7 玩家</option>
              <option value="8">8 玩家</option>
              <option value="9">9 玩家</option>
              <option value="10">10 玩家</option>
            </select>
            <input v-if="room.attrs.type === 'spy'" type="number" name="minSize" title="最小开始人数" placeholder="最小人数" v-model="room.minSize" min="4" :max="room.size" />
            <input type="button" value="创建" @click="createRoom" :disabled="!!roomPlayer" />
          </p>
        </form>
        <section v-if="roomPlayer" class="space-y-2">
          <h3>我的房间: {{ roomPlayer.room.name }} ({{ roomPlayer.room.players.filter(p => p.role == 'player').length }}/{{ roomPlayer.room.size }})</h3>
          <template v-if="roomPlayer.room.attrs?.type === 'spy'">
            <spy-room :game="game" :room-player="roomPlayer"></spy-room>
          </template>
          <template v-if="roomPlayer.room.attrs?.type === 'gobang'">
            <gobang-room :game="game" :room-player="roomPlayer"></gobang-room>
          </template>
        </section>
      </main>
    </section>
  </article>
  <footer>
    <script>
      var currentPlayer = <%- JSON.stringify(player) %>;
      var spyTemplate = `<%- include('games/spy') %>`;
      var gobangTemplate = `<%- include('games/gobang') %>`;
    </script>
    <script src="core.js"></script>
    <script src="games/spy.js"></script>
    <script src="games/gobang.js"></script>
    <script src="api.js"></script>
    <script src="main.js"></script>
  </footer>
</body>

</html>